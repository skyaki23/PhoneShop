@using PhoneShop.code
@model PhoneShop.ViewModels.HomeViewModel

<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<script src="~/Scripts/jquery.cookie.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>

<script src="~/Scripts/jquery-3.3.1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

<link href="~/Content/stylesheets/font-awesome.css" rel="stylesheet" />
<link href="~/Content/stylesheets/homeStyle.css" rel="stylesheet" />

@{
    var defaultImageURL = "/Content/images/system/placeholder-image.png"; // 預設圖片

    //設定產品輪播圖資訊
    Dictionary<string, string> carouselImage = new Dictionary<string, string>();
    Dictionary<string, string> carouselProductCategory = new Dictionary<string, string>();
    Dictionary<string, string> carouselProductName = new Dictionary<string, string>();
    var i = 0;

    //取出每筆產品資料用於產品輪播圖
    foreach (var product in Model.CarouselProducts)
    {
        var imageURL = string.IsNullOrEmpty(product.ImageURL) ? defaultImageURL : product.ImageURL; // 若產品圖片為空則使用預設圖片
        carouselImage.Add("image" + i, imageURL); // 設定產品輪播圖圖片
        carouselProductCategory.Add("category" + i, product.Category.Name); // 設定產品輪播圖產品品牌
        carouselProductName.Add("name" + i, product.Name); // 設定產品輪播圖產品名稱
        i++;
    }
}

<div class="page-title parallax">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="page-title-heading">
                    <h1 class="title">手機商店</h1>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div id="carousel" class="carousel slide" data-ride="carousel" data-interval="3000">
                <ol class="carousel-indicators" style="background-image: linear-gradient(360deg, #c0c0c0, #888888)">
                    @for (int j = 0; j < i; j++)
                    {
                        <li data-target="#carousel" data-slide-to="@j" class="@if (j == 0) { <text>active</text> } "></li>
                    }
                </ol>
                <div class="carousel-inner">
                    @for (int j = 0; j < i; j++)
                    {
                        <div class="item @if (j == 0) { <text>active</text> }" style="width: auto; height: 500px;">
                            <img class="center-block" style="width: 40%; height: 75%" src="@carouselImage["image" + j]" alt="First slide">
                            <div class="carousel-caption">
                                <h3>@carouselProductCategory["category" + j]</h3>
                                <h2>@carouselProductName["name" + j]</h2>
                            </div>
                        </div>
                    }
                </div>
                <a href="#carousel" class="left carousel-control" data-slide="prev">
                    <span class="icon-prev"></span>
                </a>
                <a href="#carousel" class="right carousel-control" data-slide="next">
                    <span class="icon-next"></span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container" style="margin-top: 100px">
    <div class="row">
        <div class="col-md-3">
            <div class="sidebar slidebar-shop">
                <div class="widget widget-search">
                    <label>
                        <input type="search" class="search-field" placeholder="搜尋..." value="">
                    </label>
                    <input type="submit" class="search-submit" value="搜尋" data-href="@Url.Action("FilterProducts", "Home")">
                </div>
                <div class="widget widget-sort-by">
                    <h5 class="widget-title">
                        產品排序依
                    </h5>
                    <ul>
                        <li><a href="#" data-href="@Url.Action("FilterProducts", "Home", new { categoryID = Model.CategoryID, sortBy = (int)SortByEnums.Default })" class="dataLink">最新</a></li>
                        <li><a href="#" data-href="@Url.Action("FilterProducts", "Home", new { categoryID = Model.CategoryID, sortBy = (int)SortByEnums.PriceLowToHigh })" class="dataLink">價錢低至高</a></li>
                        <li><a href="#" data-href="@Url.Action("FilterProducts", "Home", new { categoryID = Model.CategoryID, sortBy = (int)SortByEnums.PriceHighToLow })" class="dataLink">價錢高至低</a></li>
                    </ul>
                </div>
                <div class="widget widget_tag">
                    <h5 class="widget-title">
                        品牌查詢
                    </h5>
                    <div class="tag-list">
                        @foreach (var category in Model.Categories)
                        {
                            <a href="#" data-href="@Url.Action("FilterProducts", "Home", new { categoryID = category.ID, sortBy = Model.SortBy })" class="dataLink" style="color: #c5c5c5;">@category.Name</a>
                            <br />
                        }
                    </div>
                </div>
                <div class="widget widget-price">
                    <h5 class="widget-title">價錢條件</h5>
                    <div class="price-filter">
                        <div id="slide-range"></div>
                        <p class="amount" style="text-align: center; font-size: 16px">
                            NT$ 0 - @Model.MaximumPrice
                        </p>
                    </div>
                </div><!-- /.widget -->
                <a href="@Url.Action("Index", "Home")" class="btn btn-danger">重設</a>
            </div>
        </div>
        <div class="col-md-9">
            <div id="productsDiv">
                @{
                    //建立FilterProductsViewModel物件，屬性資料用於FilterProducts PartialView
                    var filterProductsViewModel = new FilterProductsViewModel();
                    filterProductsViewModel.Products = Model.Products;
                    filterProductsViewModel.SearchTerm = Model.SearchTerm;
                    filterProductsViewModel.CategoryID = Model.CategoryID;
                    filterProductsViewModel.SortBy = Model.SortBy;
                    filterProductsViewModel.Pager = Model.Pager;

                    Html.RenderPartial("FilterProducts", filterProductsViewModel);
                }
            </div>
        </div>
    </div>
</div>

<script>
    var preCategoryID; // 設定有已按下的品牌查詢選項
    var preSortBy; //  設定有已按下的產品排序選項
    $(".dataLink").click(function (e) {
        e.preventDefault(); // 不做跳轉網頁

        //get attribute為data-href的值，
        //用於產品排序、品牌查詢被點擊時所用，用來做FilterProducts
        var url = $(this).attr("data-href");
        
        if (url != "" || url != undefined) {

            //若url含有品牌查詢ID，表示目前用品牌查詢做篩選
            if (url.includes("categoryID")) {
                //若之前已有用品牌查詢做篩選，將該選項css做回預設
                if (preCategoryID != undefined) {
                    preCategoryID.css({
                        "font-weight": "Normal",
                        "color": "#c5c5c5",
                        "text-decoration": "none"
                    });  
                }

                //將preCategoryID設為這次品牌查詢篩選的選項
                preCategoryID = $(this);
            }

            //若url含有產品排序ID，表示目前用產品排序做篩選
            if (url.includes("sortBy")) {
                //若之前已有用產品排序做篩選，將該選項CSS做回預設
                if (preSortBy != undefined) {
                    preSortBy.css({
                        "font-weight": "Normal",
                        "color": "#c5c5c5",
                        "text-decoration": "none"
                    });
                }

                //將preSortBy設為這次產品排序篩選的選項
                preSortBy = $(this);
            }

            GetData(url); // call GetData function

            //增加CSS於產品排序、品牌查詢被點擊時
            $(this).css({
                "font-weight": "bold",
                "color": "#000",
                "text-decoration": "underline"
            });
        }
    });

    //搜尋關鍵字所用
    $(".search-submit").click(function (e) {
        e.preventDefault(); // 不做跳轉網頁

        //get attribute為search-field、data-href的值
        //用於產品排序、品牌查詢被點擊時所用，用來做FilterProducts
        var searchTerm = $('.search-field').val();
        var url = $(this).attr("data-href"); 

        if ((searchTerm != "" || searchTerm != undefined) && (url != "" || url != undefined)) {
            GetData(url + "?searchTerm=" + searchTerm); // 增加搜尋關鍵字給予後端參數用
        }
    });

    function GetData(dUrl) {
        $.ajax({
            url: dUrl,
            data: {
                searchTerm: $("#SearchTerm").val(),
                minimumPrice: priceSlider.slider("values", 0),
                maximumPrice: priceSlider.slider("values", 1),
                categoryID: $("#CategoryID").val(),
                sortBy: $("#SortBy").val()
            }
        })
        .done(function (response) {
            $('.search-field').val(""); // 等待後端回傳資料後，不論有無值都清空搜尋關鍵字
            $("#productsDiv").html(response);
        })
        .fail(function () {
            alert("FAIL");
        })
    }

    var callTimeout;
    var priceSlider = $("#slide-range").slider({
        range: true,
		min: 0,
        max: @Model.MaximumPrice,
        values: [0, @Model.MaximumPrice],
        slide: function (event, ui) {
            var minPrice = ui.values[0];
            var maxPrice = ui.values[1];
            $(".amount").text("NT$ " + minPrice + " - " + maxPrice);
            clearTimeout(callTimeout);
            callTimeout = setTimeout(PriceRangeChange, 100);
        }
    });

    function PriceRangeChange() {
        $.ajax({
			url: '@Url.Action("FilterProducts", "Home")',
            data: {
                searchTerm: $("#SearchTerm").val(),
                minimumPrice: priceSlider.slider("values", 0),
                maximumPrice: priceSlider.slider("values", 1),
                categoryID: $("#CategoryID").val(),
                sortBy: $("#SortBy").val()
			}
		})
        .done(function (response) {
            $("#productsDiv").html(response);
        })
        .fail(function () {
        	alert("FAIL");
        });
    }
</script>